---
alwaysApply: true
---
# Flutter Project Architecture Rules

## ğŸ—ï¸ Project Structure - MUST FOLLOW

This is a **feature-first architecture** Flutter project. ALL code MUST follow this structure:

```
lib/
â”œâ”€â”€ features/              # All features organized by domain
â”‚   â”œâ”€â”€ {feature_name}/
â”‚   â”‚   â”œâ”€â”€ data/         # Repositories, data sources (API calls)
â”‚   â”‚   â”œâ”€â”€ logic/        # BLoCs, Cubits (business logic)
â”‚   â”‚   â””â”€â”€ presentation/ # Screens, widgets (UI)
â”œâ”€â”€ core/                 # Shared infrastructure
â”‚   â”œâ”€â”€ di.dart          # Dependency injection (GetIt)
â”‚   â””â”€â”€ widgets/         # Reusable widgets across features
â”œâ”€â”€ router/              # App navigation (GoRouter)
â”œâ”€â”€ theme/               # App theming (Material 3)
â””â”€â”€ main.dart
```

## ğŸ“‚ File Placement Rules

### Adding New Features
When adding a new feature (e.g., "teams"), create:
```
lib/features/teams/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ teams_repository.dart      # API calls, data operations
â”œâ”€â”€ logic/
â”‚   â”œâ”€â”€ teams_bloc.dart            # Business logic
â”‚   â”œâ”€â”€ teams_event.dart           # Events (part of bloc file)
â”‚   â””â”€â”€ teams_state.dart           # States (part of bloc file)
â””â”€â”€ presentation/
    â”œâ”€â”€ teams_screen.dart          # Main screen
    â””â”€â”€ widgets/                   # Feature-specific widgets
        â””â”€â”€ team_card.dart
```

### Modifying Existing Features
- Admin feature: `lib/features/admin/`
- Auth feature: `lib/features/auth/`
- Lobby feature: `lib/features/lobby/`

### Shared Code
- Reusable widgets â†’ `lib/core/widgets/`
- Dependency injection â†’ `lib/core/di.dart`
- Navigation â†’ `lib/router/app_router.dart`
- Theming â†’ `lib/theme/app_theme.dart`

## ğŸ¯ Architecture Layers - STRICTLY ENFORCE

### 1. Data Layer (`data/`)
**Purpose**: Handle ALL data operations (API calls, database, caching)

```dart
// Example: games_repository.dart
class GamesRepository {
  final Dio _dio;  // âœ… Dio allowed here
  
  Future<List<Game>> getGames() async {
    final response = await _dio.get('/games');
    return response.data.map(...).toList();
  }
}
```

**Rules**:
- âœ… CAN use Dio, HTTP clients
- âœ… CAN parse JSON
- âœ… CAN handle errors
- âŒ NO business logic
- âŒ NO UI code

### 2. Logic Layer (`logic/`)
**Purpose**: Business logic and state management ONLY

```dart
// Example: games_bloc.dart
class GamesBloc extends Bloc<GamesEvent, GamesState> {
  final GamesRepository _repository;  // âœ… Repository injection
  
  Future<void> _onLoad(...) async {
    final games = await _repository.getGames();  // âœ… Use repository
    emit(GamesState.loaded(games));
  }
}
```

**CRITICAL RULES**:
- âœ… CAN use repositories
- âœ… CAN emit states
- âœ… CAN handle events
- âŒ **NEVER make HTTP calls directly** (use repository!)
- âŒ **NEVER import Dio** (that's for data layer!)
- âŒ NO UI code

### 3. Presentation Layer (`presentation/`)
**Purpose**: UI rendering ONLY

```dart
// Example: admin_screen.dart
class AdminScreen extends StatelessWidget {
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (_) => sl<GamesBloc>()..add(GamesLoadRequested()),
      child: BlocBuilder<GamesBloc, GamesState>(
        builder: (context, state) {
          // Render UI based on state
        },
      ),
    );
  }
}
```

**Rules**:
- âœ… CAN use BlocProvider, BlocBuilder, BlocListener
- âœ… CAN dispatch events
- âœ… CAN read state
- âŒ NO business logic
- âŒ NO API calls

## ğŸ”— Dependency Flow - MUST FOLLOW

```
Presentation â†’ Logic â†’ Data â†’ Infrastructure (Dio)
     â†“           â†“        â†“
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â†’ Core (DI, Widgets, Theme)
```

**Rules**:
- Presentation can import Logic and Core
- Logic can import Data and Core
- Data can import Core
- Core CANNOT import from features (avoid circular deps)

## ğŸ“ Import Conventions

### âœ… CORRECT Imports:
```dart
// Feature imports (use full paths)
import 'package:frontend/features/admin/logic/games_bloc.dart';
import 'package:frontend/features/admin/data/games_repository.dart';

// Core imports
import 'package:frontend/core/di.dart';
import 'package:frontend/core/widgets/widgets.dart';

// Shared models
import 'package:shared_models/shared_models.dart';
```

### âŒ WRONG Imports:
```dart
// Don't use relative imports for features
import '../../../features/admin/logic/games_bloc.dart';

// Don't import across features directly
import 'package:frontend/features/auth/logic/auth_bloc.dart';  // In admin code
```

## ğŸ”§ Dependency Injection (GetIt)

**File**: `lib/core/di.dart`

**Pattern**:
```dart
void setupDi() {
  // 1. Infrastructure
  sl.registerSingleton<Dio>(dio);
  
  // 2. Repositories (data layer)
  sl.registerLazySingleton<GamesRepository>(() => 
    GamesRepository(sl<Dio>())
  );
  
  // 3. BLoCs (logic layer)
  sl.registerFactory<GamesBloc>(() => 
    GamesBloc(sl<GamesRepository>())  // âœ… Inject repository, not Dio!
  );
}
```

**Rules**:
- Repositories are `Lazy Singleton` (one instance)
- BLoCs are `Factory` (new instance per use)
- Infrastructure is `Singleton` (Dio, etc.)

## ğŸ¨ BLoC Pattern Rules

### Event Naming:
```dart
sealed class GamesEvent extends Equatable {}

final class GamesLoadRequested extends GamesEvent {}
final class GamesCreateRequested extends GamesEvent {
  const GamesCreateRequested(this.name);
  final String name;
}
```

### State Naming:
```dart
enum GamesStatus { initial, loading, loaded, error }

final class GamesState extends Equatable {
  const GamesState._({required this.status, this.games = const []});
  
  const GamesState.initial() : this._(status: GamesStatus.initial);
  const GamesState.loading() : this._(status: GamesStatus.loading);
  const GamesState.loaded(List<Game> games) : this._(status: GamesStatus.loaded, games: games);
  
  final GamesStatus status;
  final List<Game> games;
}
```

### BLoC Structure:
```dart
class GamesBloc extends Bloc<GamesEvent, GamesState> {
  GamesBloc(this._repository) : super(const GamesState.initial()) {
    on<GamesLoadRequested>(_onLoadRequested);
    on<GamesCreateRequested>(_onCreateRequested);
  }

  final GamesRepository _repository;  // âœ… Only repository dependency
  
  Future<void> _onLoadRequested(GamesLoadRequested event, Emitter<GamesState> emit) async {
    emit(const GamesState.loading());
    try {
      final games = await _repository.getGames();  // âœ… Use repository
      emit(GamesState.loaded(games));
    } catch (e) {
      emit(GamesState.error(e.toString()));
    }
  }
}
```

## ğŸš« ANTI-PATTERNS - NEVER DO THIS

### âŒ BLoC Making HTTP Calls Directly:
```dart
class GamesBloc extends Bloc {
  final Dio _dio;  // âŒ WRONG! BLoC should NOT have Dio
  
  Future<void> load() async {
    final response = await _dio.get('/games');  // âŒ WRONG!
  }
}
```

**Fix**: Create a repository and use it!

### âŒ Random File Placement:
```dart
lib/
â”œâ”€â”€ games/              // âŒ WRONG! What is "games"?
â”‚   â””â”€â”€ games_bloc.dart
```

**Fix**: Use feature-first structure!

### âŒ Mixing Layers:
```dart
class GamesRepository {
  Future<List<Game>> getGames() async {
    final games = await _dio.get('/games');
    if (games.isEmpty) {
      emit(GamesState.empty());  // âŒ WRONG! Repository emitting BLoC states
    }
  }
}
```

**Fix**: Repositories only return data. BLoCs handle state.

## ğŸ“¦ Backend Structure

```
packages/backend/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ database.dart        # Drift database
â”‚   â””â”€â”€ helpers/            # JWT, cookies, etc.
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ games/
â”‚   â”‚   â”œâ”€â”€ index.dart      # GET /games, POST /games
â”‚   â”‚   â””â”€â”€ [id].dart       # DELETE /games/:id
â”‚   â””â”€â”€ auth/
â””â”€â”€ main.dart
```

## ğŸ§ª Testing Pattern (Future)

```
test/
â””â”€â”€ features/
    â””â”€â”€ admin/
        â”œâ”€â”€ data/
        â”‚   â””â”€â”€ games_repository_test.dart
        â”œâ”€â”€ logic/
        â”‚   â””â”€â”€ games_bloc_test.dart
        â””â”€â”€ presentation/
            â””â”€â”€ admin_screen_test.dart
```

## ğŸ“š Shared Models

**Location**: `packages/shared_models/`

**Usage**: Both frontend and backend import from here:
```dart
import 'package:shared_models/shared_models.dart';
```

Models: `Game`, `Team`, `AppUser`

## âœ… Checklist for New Features

Before creating code, verify:
1. [ ] Created feature folder in `lib/features/`
2. [ ] Created `data/` folder for repository
3. [ ] Created `logic/` folder for BLoC
4. [ ] Created `presentation/` folder for screens
5. [ ] Repository ONLY has Dio dependency
6. [ ] BLoC ONLY has Repository dependency
7. [ ] Screen ONLY uses BlocProvider/Builder
8. [ ] Registered repository in `core/di.dart`
9. [ ] Registered BLoC in `core/di.dart`
10. [ ] Used proper import paths

## ğŸ¯ Summary

**Golden Rule**: Each layer has ONE job!
- **Data** = Fetch/save data (API calls)
- **Logic** = Business logic (BLoCs)
- **Presentation** = UI rendering (Screens)

**Never cross these boundaries!**

Keep the codebase clean, testable, and maintainable. ğŸš€

